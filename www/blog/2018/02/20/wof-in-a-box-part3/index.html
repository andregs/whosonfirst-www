
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="x-ua-compatible" content="ie=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Who’s On First | WOF in a Box (part 3)</title>
		<meta name="description" content="Who’s on First is a gazetteer of places." />
		<link rel="apple-touch-icon" href="/images/favicons/apple-touch-icon.png" sizes="180x180" />
		<link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16" />
		<link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32" />
		<link rel="manifest" href="/images/favicons/manifest.json" />
		<link rel="mask-icon" href="/images/favicons/safari-pinned-tab.svg" color="#2C1E3F" />
		<link rel="stylesheet" href="/css/bootstrap.min.css" />
		<link rel="stylesheet" href="/css/mapzen.whosonfirst.css" />
		
		<link rel="stylesheet" href="/css/styles/grayscale.css" />

		<link rel="alternate" type="application/atom+xml" title="Who's On First Atom feed" href="/blog/atom_10.xml"/>		
		<link rel="alternate" type="application/rss+xml" title="Who's On First RSS 2.0 feed" href="/blog/rss_20.xml"/>

		

	</head>
	<body>
		<div class="whosonfirst-wrapper">

			<nav class="navbar navbar-default navbar-fixed-top whosonfirst-fixed-subpage-navbar">
				<div class="container">

					
					<div class="navbar-header">
						<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
							<span class="sr-only">Toggle navigation</span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</button>
						<a class="navbar-brand" href="/">Who’s On First</a>
					</div>

					
					<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
					  <ul class="nav navbar-nav navbar-right">

							<li class="whosonfirst-navbar-element-collapsed">
								<a href="/browse/" class="whosonfirst-nav-link whosonfirst-nav-link-collapsed">browse</a>
							</li>
					    
							<li class="whosonfirst-navbar-element-collapsed">
								<a href="/docs/" class="whosonfirst-nav-link whosonfirst-nav-link-collapsed">documentation</a>
							</li>
							
							<li class="whosonfirst-navbar-element-collapsed">
								<a href="/code/" class="whosonfirst-nav-link whosonfirst-nav-link-collapsed">code</a>
							</li>

							<li class="whosonfirst-navbar-element-collapsed">
								<a href="/api/" class="whosonfirst-nav-link whosonfirst-nav-link-collapsed">api</a>
							</li>
							
							<li class="whosonfirst-navbar-element-collapsed">
								<a href="/download/" class="whosonfirst-nav-link whosonfirst-nav-link-collapsed">download</a>
							</li>
							
							<li class="whosonfirst-navbar-element-collapsed">
								<a href="/blog/" class="whosonfirst-nav-link whosonfirst-nav-link-collapsed">blog</a>
							</li>
						</ul>
					</div>
				</div>
			</nav>


		<style type="text/css">
		  body {
		  font-family: serif;
		  font-size: 1.3em;
		  line-height: 1.5em;
		  }

		  h2 small {
		  display: block;
		  margin-top:.10em;
		  font-weight: 100;
		  font-size: .5em;
		  }

		  img {
		  max-width: 640px !important;
		  max-height: 480px !important;
		  border: 1px dotted #ccc;
		  padding: .5em;
		  margin-bottom:1em;
		  margin-top: 1em;
		  display:block;
		  min-width: 320px;
		  margin: 0 auto;
		  }

		  .hey-look {
		  font-weight: 700;
		  }

		  @media (min-width: 320px) and (max-width: 400px) {

		  ul {
		  margin:0px;
	  	  margin-left:15px;
		  padding:0px;
		  }

		  pre {
		  max-width:250px;
		  overflow:scroll;
		  }

		  img {
		  max-width: 250px !important;
		  max-height: 200px !important;
		  min-width: 75px;
		  }
		  }

		</style>

			<div class="container whosonfirst-subpage-container">
			  <div class="row">
			    <div class="col-lg-1 col-md-1 col-sm-1 col-xs-0">
 			    </div>
			    <div class="col-lg-10 col-md-10 col-sm-10 col-xs-12">
			      <article>

	  
	  
	  <h2>
	    WOF in a Box (part 3)
	    <small>This is a blog post by
	      <span class="hey-look">thisisaaronland</span>
	      that was published on <span class="pubdate"><a href="/blog/2018/02/">Feb</a> <a href="/blog/2018/02/20">20</a>, <a href="/blog/2018/">2018</a></span>
	       and tagged <span class="hey-look">spelunker</span> and <span class="hey-look">whosonfirst</span></small>
	  </h2>

<p>The Who&rsquo;s On First Spelunker lives again! It&rsquo;s new home is:</p>

<div style="font-size:2em; text-align:center; margin-top:1em;">
     <a href="https://spelunker.whosonfirst.org/">https://spelunker.whosonfirst.org/</a>
</div>

<p>All the old URLs should work as before once you update the root, replacing
<code>whosonfirst.mapzen.com/spelunker</code> with <code>spelunker.whosonfirst.org</code>. For example, the URL for the Who&rsquo;s On First record for
<a href="https://spelunker.whosonfirst.org/id/102031307/">Tokyo</a> used to be:</p>

<div style="font-size:2em; text-align:center; margin-top:1em;">
     <a href="#" style="color:#666 !important;">https://whosonfirst.mapzen.com/spelunker/id/102031307/</a>
</div>

<p>And now it is:</p>

<div style="font-size:2em; text-align:center; margin-top:1em;">
     <a href="https://spelunker.whosonfirst.org/id/102031307/">https://spelunker.whosonfirst.org/id/102031307/</a>
</div>

<hr />

<p>The Spelunker was rebuilt on a bare <a href="https://wiki.ubuntu.com/XenialXerus/ReleaseNotes">Ubuntu
16.04</a> Linux server, following
Dan&rsquo;s <a href="/blog/2017/12/21/wof-in-a-box/">WOF in a Box</a> instructions and
everything worked without a hitch. Along the way, I made some updates to the
&ldquo;fetching and indexing data&rdquo; piece specifically to make things &ldquo;faster and
easier&rdquo; for people who just want to work with the data as-is and don&rsquo;t need to
make updates.</p>

<p><em>These updates actually introduced some &ldquo;hitches&rdquo; in Dan&rsquo;s guide but with <a href="https://www.vicchi.org/">Gary
Gale</a> &rsquo;s help we were able to make short work of those
bugs and everything should work as advertised again&hellip;</em></p>

<p>Historically all the Who&rsquo;s On First tools have been designed to work with the
raw (plain-text GeoJSON) data contained in the GitHub repositories. It&rsquo;s
important that there always be tooling to work with the raw &ldquo;at rest&rdquo; data but
it can be unnecessarily fiddly for a lot of people.</p>

<p>We&rsquo;ve been doing a lot of work recently to distribute Who&rsquo;s On First data as
SQLite databases. SQLite databases have the advantage of being self-contained
and widespread support in a variety of tools and programming languages. They
don&rsquo;t currently include &ldquo;alternate geometry&rdquo; WOF records but those
aren&rsquo;t necessary (yet) for most things people want to do with WOF related tools.</p>

<p>The first tool that we wrote is a simple command-line tool to fetch all of the
databases defined in an <code>inventory.json</code> file. These <code>inventory.json</code> files are still a work in progress and currently only
published for SQLite databases. As we chip away at the remaining work to
generate other Who&rsquo;s On First distributions the plan is to adopt (and adapt) the
inventory files accordingly.</p>

<p>Here&rsquo;s how to the <a href="https://github.com/whosonfirst/go-whosonfirst-dist#wof-dist-fetch">wof-dist-fetch</a> tool works. In this example we&rsquo;re going to
ask the tool to fetch <em>every</em> database listed in the inventory file, and
store them in a folder called <code>/usr/local/data</code>:</p>

<pre><code>&gt; wof-dist-fetch -inventory https://dist.whosonfirst.org/sqlite/inventory.json -dest /usr/local/data
...time passes...

&gt; ls -d /usr/local/data/whosonfirst-data*
/usr/local/data/whosonfirst-data-constituency-ca.db
/usr/local/data/whosonfirst-data-constituency-ca-latest.db
/usr/local/data/whosonfirst-data-constituency-us-latest.db
...
/usr/local/data/whosonfirst-data-venue-us-wy-latest.db
/usr/local/data/whosonfirst-data-venue-uy-latest.db
/usr/local/data/whosonfirst-data-venue-za-latest.db
</code></pre>

<p>This replaces the steps described in the <a href="/blog/2017/12/21/wof-in-a-box/#download">Download some
data</a> section of Dan&rsquo;s post. It will
still take a while to download all the SQLite databases but they are generally
smaller and easier to work with than the Git repositories and don&rsquo;t require
setting up additional tools like <a href="https://github.com/whosonfirst-data/whosonfirst-data#git-and-large-files">Git LFS</a>.</p>

<p>This tool is part of the <a href="https://github.com/whosonfirst/go-whosonfirst-dist">go-whosonfirst-dist</a> package which will also be used
to <em>generate</em> those SQLite files (and other distributions) but it still being
actively developed so you probably shouldn&rsquo;t try using it yet, unless you are
feeling adventurous.</p>

<p>The second tool that we wrote was actually just an update to one of the very
first tools we ever wrote: The [wof-es-index]() tool which is used to crawl a
directory full of Who&rsquo;s On First GeoJSON data files and index them in the Who&rsquo;s
On First Spelunker [Elasticsearch index]().</p>

<p>The tool has been updated to also read and index WOF data stored in the SQLite
databases we&rsquo;re generating. In <a href="/blog/2017/12/21/wof-in-a-box/#index">Dan&rsquo;s original blog
post</a> you would index the Spelunker like this:</p>

<pre><code>&gt; cd /usr/local/data/whosonfirst-data
&gt; wof-es-index -s . --index=spelunker -b
</code></pre>

<p>And now you can do this:</p>

<pre><code>&gt; wof-es-index -b -m sqlite /usr/local/data/whosonfirst-data-*-latest.db
</code></pre>

<p>The <code>-s(ource)</code> flag has been deprecated and replaced with the <code>-m(ode)</code> flag
which can <a href="https://github.com/whosonfirst/py-mapzen-whosonfirst-index">index a number of different data sources</a>: Git repositories, SQLite
databases, one or more GeoJSON files and so on. It is also no longer necessary
to pass the <code>-i(ndex)</code> flag since it defaults to &ldquo;spelunker&rdquo; now. The trusty
<code>-b(ulk)</code> flags remains unchanged for speeding up indexing.</p>

<hr />

<p>There&rsquo;s been a lot of work on the SQLite databases adding full-text and spatial
functionality as well as refactoring the code in to re-usable components so that
it can be used for other kinds of data, specifically <a href="https://github.com/whosonfirst-data/whosonfirst-brands">Who&rsquo;s On First
brands</a> and Markdown files.</p>

<ul>
<li><p><a href="https://github.com/whosonfirst/go-whosonfirst-sqlite#interfaces">https://github.com/whosonfirst/go-whosonfirst-sqlite#interfaces</a></p></li>

<li><p><a href="https://github.com/whosonfirst/go-whosonfirst-sqlite-features">https://github.com/whosonfirst/go-whosonfirst-sqlite-features</a></p></li>

<li><p><a href="https://github.com/whosonfirst/go-whosonfirst-sqlite-brands">https://github.com/whosonfirst/go-whosonfirst-sqlite-brands</a></p></li>

<li><p><a href="https://github.com/whosonfirst/go-whosonfirst-sqlite-markdown">https://github.com/whosonfirst/go-whosonfirst-sqlite-markdown</a></p></li>
</ul>

<p>The support for Markdown files is not as much of a non-sequitur as it might
seem. Part of living in a <a href="blog/2018/01/02/chapter-two/">post-Mapzen world</a> has involved moving all the
Who&rsquo;s On First blog posts (from the Mapzen website) <a href="/blog">over here</a>. That&rsquo;s
meant writing <a href="https://github.com/whosonfirst/go-whosonfirst-markdown">our own suite of tools</a> to render the Jekyll-flavoured Markdown
files that we&rsquo;ve always used for blog posts.</p>

<p>We launched <a href="/blog/2017/07/28/wof-website-redesign/">&ldquo;version 2&rdquo;</a> of the Who&rsquo;s
On First website last summer, the result of <a href="http://scottdombkowski.com/">Scott
Dombrowski</a> &rsquo;s internship with Mapzen. It has been
a huge UI and UX improvement and helped corral all the many different sources of
documentation in to one place.</p>

<p>On the other hand the website still requires more work than it should in order to update or
add new pages so &ldquo;version 3&rdquo; will essentially be Markdown files written by hand or derived
from machine readable data that will be rendered as HTML with the same tools
that I wrote for the blog.</p>

<p>The value of being able to index Markdown files in SQLite is that we are now able to do full-text search, first for the blog but ultimately for all the WOF related
documentation, once <a href="https://github.com/whosonfirst/whosonfirst-www/milestone/3">the &ldquo;version 3&rdquo; work</a> is completed:</p>

<pre><code>&gt; ./bin/wof-sqlite-query-markdown -dsn test.db montreal
15:49:12.499695 [wof-sqlite-query-markdown] STATUS montreal - /blog/2015/08/18/who-s-on-first/
15:49:12.499856 [wof-sqlite-query-markdown] STATUS montreal - /blog/2017/04/04/whosonfirst-api/
15:49:12.499906 [wof-sqlite-query-markdown] STATUS montreal - /blog/2017/10/17/whosonfirst-nacis-2017/
15:49:12.499936 [wof-sqlite-query-markdown] STATUS montreal - /blog/2017/12/22/neighbourhood-updates-three/
15:49:12.500024 [wof-sqlite-query-markdown] STATUS montreal - /blog/2015/08/18/who-s-on-first/
</code></pre>

<p>We used the blog as a testing and proving ground for how full-text search should
work and then applied those lessons to the tools we use to index brands:</p>

<pre><code>&gt; ./bin/wof-sqlite-query-brands -dsn test.db 'car* bank'
17:23:40.459620 [wof-sqlite-query-brands] STATUS car* bank - 1125154403 Carolina First Bank
17:23:40.459746 [wof-sqlite-query-brands] STATUS car* bank - 1125153083 Central Carolina Bank
</code></pre>

<p>And then finally for actual <a href="https://github.com/whosonfirst/go-whosonfirst-sqlite-features#wof-sqlite-query-features">Who&rsquo;s On First documents</a>:</p>

<pre><code>&gt; ./bin/wof-sqlite-query-features -dsn test2.db JFK
102534365,John F Kennedy Int'l Airport

./bin/wof-sqlite-query-features -dsn test2.db -column names_colloquial Paris
85922583,San Francisco
102027181,Shanghai
102030585,Kolkata
101751929,Tromsø
</code></pre>

<p>&hellip;Spatialite!</p>

<pre><code>&gt; ./bin/wof-sqlite-index-features -timings -live-hard-die-fast -spr -geometries -driver spatialite -mode repo -dsn test.db /usr/local/data/whosonfirst-data-constituency-ca/
10:09:46.534281 [wof-sqlite-index-features] STATUS time to index geometries (87) : 21.251828704s
10:09:46.534379 [wof-sqlite-index-features] STATUS time to index spr (87) : 3.206930799s
10:09:46.534385 [wof-sqlite-index-features] STATUS time to index all (87) : 24.48004637s

&gt; sqlite3 test.db
SQLite version 3.21.0 2017-10-24 18:55:49
Enter &quot;.help&quot; for usage hints.

sqlite&gt; SELECT load_extension('mod_spatialite.dylib');
sqlite&gt; SELECT s.id, s.name FROM spr s, geometries g WHERE ST_Intersects(g.geom, GeomFromText('POINT(-122.229137 49.450129)', 4326)) AND g.id = s.id;
1108962831|Maple Ridge-Pitt Meadows
</code></pre>

<p>There is also a <code>spatialite</code> branch of the <a href="https://github.com/whosonfirst/go-whosonfirst-pip-v2/">Who&rsquo;s On First point-in-polygon
(PIP) server</a>. The idea
is to speed up indexing time and memory usage (and maybe even query time) by teaching
the code to use the newer SQLite databases instead of an <a href="/blog/2016/02/19/iamhere/">in-memory RTree</a>:</p>

<ul>
<li><a href="https://github.com/whosonfirst/go-whosonfirst-pip-v2/tree/spatialite">https://github.com/whosonfirst/go-whosonfirst-pip-v2/tree/spatialite</a></li>
</ul>

<p>This is code that <em>does not work</em> yet and I am going to kick the tires using
another <a href="https://github.com/aaronland/go-marc">unrelated project</a> that I started working on for the New South Wales
library last year that will allow them to upload a CSV file full of MARC 034
fields and get back a CSV file of WOF IDs which intersect that bounding box (034
field).</p>

		</article>
		</div>
		</div>	
		</div>	

		<footer>
			<nav class="navbar navbar-default navbar-bottom">
				<div class="container">
					
					<ul class="nav navbar-nav navbar-right whosonfirst-footer">
						<li><a href="/docs/contributing/" class="whosonfirst-nav-link whosonfirst-footer-nav-link">contributing</a></li>
						<li><a href="/docs/licenses/" class="whosonfirst-nav-link whosonfirst-footer-nav-link">license</a></li>
						<li><a href="https://twitter.com/alloftheplaces/" class="whosonfirst-nav-link whosonfirst-footer-nav-link">twitter</a></li>
					</ul>
				</div>
			</nav>
		</footer>

		
		<script src="/javascript/jquery.min.js"></script>
		
		<script src="/javascript/bootstrap.min.js"></script>
		<script src="/javascript/mapzen.whosonfirst.home.js"></script>
		<script src="/javascript/mapzen.whosonfirst.subpage.js"></script>
		
		<script src="/javascript/highlightpack.js"></script>
		<script>
		  try {
		  	hljs.initHighlightingOnLoad();
		  } catch (e) {
		  	console.log("HLJS", e);
		  }
		</script>
	</body>
</html>

