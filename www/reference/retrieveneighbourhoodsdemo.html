<!DOCTYPE html>
<html lang="en">
	<head>
		<title>My Web Map</title>
		<meta charset="utf-8">
		<link rel="stylesheet" href="https://mapzen.com/js/mapzen.css">
		<script src="https://mapzen.com/js/mapzen.min.js"></script>
		<style>
			#map {
				height: 100%;
				width: 100%;
				position: absolute;
			}
			html,body{margin: 0; padding: 0;}
		</style>
	</head>
	<body onload="runWhosOnFirstAPI()">
		<div id="map"></div>
		<script src="../javascript/mapzen.whosonfirst.api.js"></script>
		<script src="../javascript/jquery.min.js"></script>
		<script>
			L.Mapzen.apiKey = 'mapzen-aetZmeQ';
			var map = L.Mapzen.map('map', {
				tangramOptions: {
					scene: {
						import: [
							'https://mapzen.com/carto/refill-style/8/refill-style.zip', 'https://mapzen.com/carto/refill-style/8/themes/color-gray.zip', 'https://mapzen.com/carto/refill-style/8/themes/detail-1.zip'
					] } }
			});
			map.setView([37.77493, -122.41942], 14);
			
			// How we should handle each API result
			var show_plane = function(place) {
				$.get(place['mz:uri'], function(result) {
					L.geoJSON(result, {style: function (feature) {
						randomNumber1 = 86+Math.ceil(Math.random()*100);
						color = "rgb("+randomNumber1+","+randomNumber1+","+randomNumber1+")"
						return {color: '#888888', weight: 1, opacity: '.7', fillColor: color, fillOpacity: .5};
					}}).addTo(map);
				});
			}

			// NOOP (we are using onprogress instead)
			var onsuccess = function() { return; };

			// Just log errors to the JS console
			var onerror = function(rsp) {
				console.error(rsp);
			};

			// Take all the API results and show them on the map
			var onprogress = function(rsp) {
				//console.log(rsp);
				for (var i = 0; i < rsp.places.length; i++) {
					var place = rsp.places[i];
					show_plane(place);
				}
			};

			function runWhosOnFirstAPI() {
				// Setup the API key
				mapzen.whosonfirst.api.set_handler('authentication', function() {
					return 'mapzen-aetZmeQ';
				});
				// Get all the venues in the Flatiron District
				// See: https://mapzen.com/documentation/places/methods/#whosonfirst.places.getDescendants
				var parent_id = '85922583';
				var method = 'whosonfirst.places.getDescendants';
				var data = {
					id: parent_id,
					per_page: 500,
					extras: 'mz:uri,geom:latitude,geom:longitude', // this gets us lat/lng coords
					placetype: 'neighbourhood'
				};
				// Ok now we actually call the API
				mapzen.whosonfirst.api.execute_method_paginated(method, data, onsuccess, onerror, onprogress);
			};
		</script>
	</body>
</html>